from dataclasses import dataclass, field

from vulnfinder.domain.analysis.value_objects.identifiers import AnalysisRunId
from vulnfinder.domain.codebase.value_objects.identifiers import CodeSnippetId
from vulnfinder.domain.common.entities.base_aggregate import BaseAggregateRoot
from vulnfinder.domain.common.entities.base_entity import BaseEntity
from vulnfinder.domain.knowledge_base.value_objects.identifiers import CVEId, CWEId
from vulnfinder.domain.vulnerability.value_objects.identifiers import (
    VulnerabilityEvidenceId,
    VulnerabilityId,
    VulnerabilityReportId,
)
from vulnfinder.domain.vulnerability.value_objects.types import (
    Confidence,
    Recommendation,
    Severity,
    VulnerabilityType,
)


@dataclass(eq=False, kw_only=True)
class VulnerabilityEvidence(BaseEntity[VulnerabilityEvidenceId]):
    snippet: str
    reasoning: str | None = None
    source: str | None = None


@dataclass(eq=False, kw_only=True)
class Vulnerability(BaseEntity[VulnerabilityId]):
    vulnerability_type: VulnerabilityType
    severity: Severity
    confidence: Confidence
    description: str
    code_snippet_id: CodeSnippetId | None = None
    cve_id: CVEId | None = None
    cwe_id: CWEId | None = None
    recommendation: Recommendation | None = None
    evidence: list[VulnerabilityEvidence] = field(default_factory=list)

    def add_evidence(self, evidence: VulnerabilityEvidence) -> None:
        self.evidence.append(evidence)


@dataclass(eq=False, kw_only=True)
class VulnerabilityReport(BaseAggregateRoot[VulnerabilityReportId]):
    analysis_run_id: AnalysisRunId | None = None
    vulnerabilities: list[Vulnerability] = field(default_factory=list)

    def add_vulnerability(self, vulnerability: Vulnerability) -> None:
        self.vulnerabilities.append(vulnerability)

