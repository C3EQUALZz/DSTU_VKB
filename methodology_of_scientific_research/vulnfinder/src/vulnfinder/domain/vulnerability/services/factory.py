from vulnfinder.domain.analysis.value_objects.identifiers import AnalysisRunId
from vulnfinder.domain.codebase.value_objects.identifiers import CodeSnippetId
from vulnfinder.domain.common.ports.uuid_provider import UUIDProvider
from vulnfinder.domain.common.services.base import BaseDomainService
from vulnfinder.domain.knowledge_base.value_objects.identifiers import CVEId, CWEId
from vulnfinder.domain.vulnerability.entities.core import (
    Vulnerability,
    VulnerabilityEvidence,
    VulnerabilityReport,
)
from vulnfinder.domain.vulnerability.value_objects.identifiers import (
    VulnerabilityEvidenceId,
    VulnerabilityId,
    VulnerabilityReportId,
)
from vulnfinder.domain.vulnerability.value_objects.types import (
    Confidence,
    Recommendation,
    Severity,
    VulnerabilityType,
)


class VulnerabilityFactory(BaseDomainService):
    def __init__(self, uuid_provider: UUIDProvider) -> None:
        super().__init__()
        self._uuid_provider = uuid_provider

    def create_report(self, analysis_run_id: AnalysisRunId | None = None) -> VulnerabilityReport:
        return VulnerabilityReport(
            id=VulnerabilityReportId(value=self._uuid_provider()),
            analysis_run_id=analysis_run_id,
        )

    def create_vulnerability(
        self,
        vulnerability_type: VulnerabilityType,
        severity: Severity,
        confidence: Confidence,
        description: str,
        code_snippet_id: CodeSnippetId | None = None,
        cve_id: CVEId | None = None,
        cwe_id: CWEId | None = None,
        recommendation: Recommendation | None = None,
    ) -> Vulnerability:
        return Vulnerability(
            id=VulnerabilityId(value=self._uuid_provider()),
            vulnerability_type=vulnerability_type,
            severity=severity,
            confidence=confidence,
            description=description,
            code_snippet_id=code_snippet_id,
            cve_id=cve_id,
            cwe_id=cwe_id,
            recommendation=recommendation,
        )

    def create_evidence(self, snippet: str, reasoning: str | None = None) -> VulnerabilityEvidence:
        return VulnerabilityEvidence(
            id=VulnerabilityEvidenceId(value=self._uuid_provider()),
            snippet=snippet,
            reasoning=reasoning,
        )

