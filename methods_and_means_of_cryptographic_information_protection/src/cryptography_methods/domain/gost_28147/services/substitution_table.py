"""Таблица замен (S-блоки) для ГОСТ 28147-89."""
import logging
from typing import Final

from cryptography_methods.domain.gost_28147.services.bit_utils import Gost28147BitUtils

logger: Final[logging.Logger] = logging.getLogger(__name__)

# S-блоки ГОСТ 28147-89
SBOX: Final[list[list[int]]] = [
    [0x9, 0x6, 0x3, 0x2, 0x8, 0xB, 0x1, 0x7, 0xA, 0x4, 0xE, 0xF, 0xC, 0x0, 0xD, 0x5],
    [0x3, 0x7, 0xE, 0x9, 0x8, 0xA, 0xF, 0x0, 0x5, 0x2, 0x6, 0xC, 0xB, 0x4, 0xD, 0x1],
    [0xE, 0x4, 0x6, 0x2, 0xB, 0x3, 0xD, 0x8, 0xC, 0xF, 0x5, 0xA, 0x0, 0x7, 0x1, 0x9],
    [0xE, 0x7, 0xA, 0xC, 0xD, 0x1, 0x3, 0x9, 0x0, 0x2, 0xB, 0x4, 0xF, 0x8, 0x5, 0x6],
    [0xB, 0x5, 0x1, 0x9, 0x8, 0xD, 0xF, 0x0, 0xE, 0x4, 0x2, 0x3, 0xC, 0x7, 0xA, 0x6],
    [0x3, 0xA, 0xD, 0xC, 0x1, 0x2, 0x0, 0xB, 0x7, 0x5, 0x9, 0x4, 0x8, 0xF, 0xE, 0x6],
    [0x1, 0xD, 0x2, 0x9, 0x7, 0xA, 0x6, 0x0, 0x8, 0xC, 0x4, 0x5, 0xF, 0x3, 0xB, 0xE],
    [0xB, 0xA, 0xF, 0x5, 0x0, 0xC, 0xE, 0x8, 0x6, 0x2, 0x3, 0x9, 0x1, 0x7, 0xD, 0x4],
]


class Gost28147SubstitutionTable:
    """Класс для работы с таблицей замен (S-блоки)."""

    def __init__(self, bit_utils: Gost28147BitUtils) -> None:
        self._bit_utils: Final[Gost28147BitUtils] = bit_utils

    def apply(self, block32b: int) -> int:
        """Применяет таблицу замен (S-блоки) к 32-битному блоку.

        Args:
            block32b: 32-битный блок

        Returns:
            Преобразованный 32-битный блок
        """
        logger.debug(f"Applying substitution table to: 0x{block32b:08X}")
        blocks4bits = self._bit_utils.split_32_bits_to_4_bits(block32b)
        self._apply_by_4_bits(blocks4bits)
        result = self._bit_utils.join_4_bits_to_32_bits(blocks4bits)
        logger.debug(f"Substitution table result: 0x{result:08X}")
        return result

    @staticmethod
    def _apply_by_4_bits(blocks4b: list[int]) -> None:
        """Применяет S-блоки к 4-битным блокам.

        Args:
            blocks4b: Массив из 8 4-битных блоков (изменяется на месте)
        """
        for i in range(8):
            sbox_row = 7 - i
            block4b = blocks4b[i]
            blocks4b[i] = SBOX[sbox_row][block4b]
            logger.debug(f"S-box[{sbox_row}][{block4b:01X}] = {blocks4b[i]:01X}")


